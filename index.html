<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGB Acquapark</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#06b6d4"/>
    <style>
        /* Estilo para esconder as telas não ativas */
        .screen { display: none; }
        .active-screen { display: block; }
        /* Botão flutuante */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 50;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <!-- Container Principal -->
    <div id="app-container" class="max-w-lg mx-auto bg-white shadow-lg min-h-screen">

        <!-- Tela de Carregamento -->
        <div id="tela-loading" class="screen active-screen flex items-center justify-center h-screen">
            <p class="text-lg text-gray-600">Carregando...</p>
        </div>

        <!-- Tela de Login -->
        <div id="tela-login" class="screen p-8">
            <div class="flex justify-center mb-8">
                <img src="https://via.placeholder.com/150" alt="Logomarca SGB Acquapark" class="w-32 h-32 rounded-full">
            </div>
            <h2 class="text-2xl font-bold text-center text-cyan-700 mb-6">SGB Acquapark</h2>
            <form id="form-login">
                <div class="mb-4">
                    <label for="login-email" class="block text-gray-700">Usuário (Email)</label>
                    <input type="email" id="login-email" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-gray-700">Senha</label>
                    <input type="password" id="login-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-cyan-500">
                </div>
                <button type="submit" class="w-full bg-cyan-600 text-white py-2 rounded-md hover:bg-cyan-700 transition-colors">Entrar</button>
            </form>
             <p id="login-error" class="text-red-500 text-center mt-4"></p>
             <p class="text-center mt-4"><a href="#" id="setup-ceo-link" class="text-sm text-blue-600 hover:underline">Configurar primeiro CEO</a></p>
        </div>

        <!-- ======================================================================================= -->
        <!-- =================================== TELAS DO CEO ====================================== -->
        <!-- ======================================================================================= -->
        <div id="tela-ceo-home" class="screen p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Painel do CEO</h2>
            <div class="grid grid-cols-1 gap-4">
                <button onclick="navigateTo('tela-ceo-usuarios')" class="bg-blue-500 text-white py-4 rounded-md hover:bg-blue-600">Gerenciar Usuários</button>
                <button onclick="navigateTo('tela-gerenciar-passaportes')" class="bg-green-500 text-white py-4 rounded-md hover:bg-green-600">Gerenciar Passaportes</button>
                <button onclick="navigateTo('tela-ceo-planos')" class="bg-purple-500 text-white py-4 rounded-md hover:bg-purple-600">Gerenciar Planos</button>
                <button onclick="logout()" class="bg-red-500 text-white py-2 rounded-md mt-8">Sair</button>
            </div>
        </div>

        <div id="tela-ceo-usuarios" class="screen p-6">
            <button onclick="navigateTo('tela-ceo-home')" class="floating-btn bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">&larr;</button>
            <h3 class="text-xl font-bold mb-4">Gerenciar Usuários</h3>
            <!-- Criar Usuário -->
            <form id="form-criar-usuario" class="bg-gray-50 p-4 rounded-lg mb-6">
                <h4 class="font-semibold mb-2">Criar Novo Usuário</h4>
                <input type="email" id="novo-usuario-email" placeholder="Email do novo usuário" required class="w-full mb-2 p-2 border rounded">
                <select id="novo-usuario-role" class="w-full mb-2 p-2 border rounded">
                    <option value="Secretaria">Secretaria</option>
                    <option value="Portaria">Portaria</option>
                    <option value="CEO">CEO</option>
                </select>
                <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Criar Usuário</button>
            </form>
            <!-- Lista de Usuários -->
            <div id="lista-usuarios">
                <p>Carregando usuários...</p>
            </div>
        </div>

        <div id="tela-ceo-planos" class="screen p-6">
             <button onclick="navigateTo('tela-ceo-home')" class="floating-btn bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">&larr;</button>
            <h3 class="text-xl font-bold mb-4">Gerenciar Planos</h3>
            <!-- Criar/Editar Plano -->
            <form id="form-plano" class="bg-gray-50 p-4 rounded-lg mb-6">
                 <h4 class="font-semibold mb-2" id="form-plano-titulo">Novo Plano</h4>
                 <input type="hidden" id="plano-id">
                 <input type="text" id="plano-nome" placeholder="Nome do Plano" required class="w-full mb-2 p-2 border rounded">
                 <input type="number" id="plano-valor" placeholder="Valor Mensal" required class="w-full mb-2 p-2 border rounded" step="0.01">
                 <textarea id="plano-descricao" placeholder="Descrição" required class="w-full mb-2 p-2 border rounded"></textarea>
                 <button type="submit" class="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600">Salvar Plano</button>
                 <button type="button" onclick="resetFormPlano()" class="w-full bg-gray-400 text-white p-2 rounded mt-2">Cancelar Edição</button>
            </form>
            <!-- Lista de Planos -->
            <div id="lista-planos">
                <p>Carregando planos...</p>
            </div>
        </div>

        <!-- ======================================================================================= -->
        <!-- =========================== TELAS DE SECRETARIA E CEO ================================= -->
        <!-- ======================================================================================= -->
        <div id="tela-gerenciar-passaportes" class="screen p-6">
            <button onclick="goBackToHome()" class="floating-btn bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">&larr;</button>
            <h3 class="text-xl font-bold mb-4">Gerenciar Passaportes</h3>
            <button onclick="navigateTo('tela-criar-passaporte')" class="w-full bg-green-500 text-white p-3 rounded-md hover:bg-green-600 mb-6">Criar Novo Passaporte</button>
            <!-- Busca -->
            <form id="form-buscar-passaporte" class="flex gap-2 mb-4">
                <input type="text" id="busca-passaporte-input" class="flex-grow p-2 border rounded" placeholder="Buscar...">
                <select id="busca-passaporte-select" class="p-2 border rounded bg-white">
                    <option value="nomeResponsavel">Nome do Responsável</option>
                    <option value="cpf">CPF</option>
                </select>
                <button type="submit" class="bg-blue-500 text-white px-4 rounded">Buscar</button>
            </form>
            <!-- Lista de Passaportes -->
            <div id="lista-passaportes">
                <p>Carregando passaportes recentes...</p>
            </div>
        </div>

        <div id="tela-criar-passaporte" class="screen p-6">
            <button onclick="navigateTo('tela-gerenciar-passaportes')" class="floating-btn bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">&larr;</button>
            <h3 class="text-xl font-bold mb-4">Novo Passaporte - Responsável</h3>
            <form id="form-criar-passaporte" class="space-y-3">
                <input type="text" id="resp-nome" placeholder="Nome Completo" required class="w-full p-2 border rounded">
                <input type="text" id="resp-cpf" placeholder="CPF" required class="w-full p-2 border rounded">
                <input type="date" id="resp-nascimento" required class="w-full p-2 border rounded text-gray-500">
                <input type="email" id="resp-email" placeholder="Email" required class="w-full p-2 border rounded">
                <input type="tel" id="resp-telefone" placeholder="Telefone" required class="w-full p-2 border rounded">
                <input type="text" id="resp-endereco" placeholder="Endereço Completo" required class="w-full p-2 border rounded">
                <select id="resp-plano" required class="w-full p-2 border rounded bg-white"></select>

                <div class="p-3 border rounded-lg">
                    <p class="font-medium text-gray-700 mb-2">Passaporte Novo?</p>
                    <div class="flex items-center gap-x-6">
                        <div class="flex items-center">
                            <input id="passaporte-novo-sim" name="passaporte-novo" type="radio" value="sim" checked class="h-4 w-4 border-gray-300 text-cyan-600 focus:ring-cyan-600">
                            <label for="passaporte-novo-sim" class="ml-2 block text-sm font-medium leading-6 text-gray-900">Sim</label>
                        </div>
                        <div class="flex items-center">
                            <input id="passaporte-novo-nao" name="passaporte-novo" type="radio" value="nao" class="h-4 w-4 border-gray-300 text-cyan-600 focus:ring-cyan-600">
                            <label for="passaporte-novo-nao" class="ml-2 block text-sm font-medium leading-6 text-gray-900">Não</label>
                        </div>
                    </div>
                </div>

                <div id="campos-passaporte-antigo" class="hidden space-y-3 pt-3 border-t mt-3">
                    <input type="text" id="tipo-passaporte-antigo" placeholder="Tipo de Passaporte Antigo" class="w-full p-2 border rounded">
                    <input type="text" id="numero-passaporte-antigo" placeholder="Número do Passaporte Antigo" class="w-full p-2 border rounded">
                </div>

                <button type="submit" class="w-full bg-green-600 text-white p-3 rounded-md hover:bg-green-700">Criar Passaporte e Cliente</button>
            </form>
        </div>

        <div id="tela-editar-passaporte" class="screen p-6">
             <button onclick="navigateTo('tela-gerenciar-passaportes')" class="floating-btn bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">&larr;</button>
             <h3 class="text-xl font-bold mb-4">Editar Passaporte</h3>
             <div id="passaporte-info-nao-editavel" class="bg-gray-100 p-4 rounded-lg mb-4"></div>
             <form id="form-editar-passaporte" class="space-y-3 mb-6"></form>
             <hr class="my-6">
             <h4 class="text-lg font-semibold mb-4">Carteirinhas Vinculadas</h4>
             <button onclick="navigateToAddCard()" class="w-full bg-cyan-500 text-white p-3 rounded-md hover:bg-cyan-600 mb-4">Adicionar Nova Carteirinha</button>
             <div id="lista-carteirinhas-passaporte" class="space-y-4"></div>
        </div>

        <div id="tela-adicionar-carteirinha" class="screen p-6">
            <button onclick="goBackToEditPassport()" class="floating-btn bg-gray-500 text-white w-12 h-12 rounded-full flex items-center justify-center shadow-lg">&larr;</button>
            <h3 class="text-xl font-bold mb-4" id="carteirinha-form-title">Adicionar Carteirinha</h3>
            <form id="form-carteirinha" class="space-y-3">
                <input type="hidden" id="carteirinha-id">
                <input type="hidden" id="carteirinha-passaporte-id">
                <select id="carteirinha-parentesco" required class="w-full p-2 border rounded bg-white">
                    <option value="Titular">Titular</option>
                    <option value="Conjuge">Cônjuge</option>
                    <option value="Filho">Filho(a)</option>
                    <option value="Pai">Pai</option>
                    <option value="Mae">Mãe</option>
                    <option value="Outro">Outro</option>
                </select>
                <input type="text" id="carteirinha-nome" placeholder="Nome Completo" required class="w-full p-2 border rounded">
                <input type="text" id="carteirinha-doc" placeholder="CPF ou Documento" class="w-full p-2 border rounded">
                <input type="date" id="carteirinha-nascimento" required class="w-full p-2 border rounded text-gray-500">

                <div class="border p-3 rounded-lg">
                    <label for="carteirinha-foto-rosto" class="block font-medium text-gray-700">Foto do Rosto (3x4, max 150kb)</label>
                    <input type="file" id="carteirinha-foto-rosto" accept="image/*" capture="user" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                    <img id="rosto-preview" class="hidden mt-2 w-32 h-40 object-cover rounded">
                </div>
                 <div class="border p-3 rounded-lg">
                    <label for="carteirinha-foto-doc" class="block font-medium text-gray-700">Foto do Documento (max 400kb)</label>
                    <input type="file" id="carteirinha-foto-doc" accept="image/*" capture="environment" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
                    <img id="doc-preview" class="hidden mt-2 w-48 h-auto object-cover rounded">
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white p-3 rounded-md hover:bg-blue-700">Salvar Carteirinha</button>
            </form>
        </div>


        <!-- ======================================================================================= -->
        <!-- =============================== TELA DA PORTARIA ====================================== -->
        <!-- ======================================================================================= -->
        <div id="tela-portaria-home" class="screen p-2 md:p-6">
            <h2 class="text-2xl font-bold text-center text-gray-800 my-4">Leitor de QR Code</h2>
            <div id="qr-reader" class="w-full mx-auto md:w-[500px]"></div>
            <div id="qr-reader-results" class="text-center mt-4"></div>
            <button onclick="logout()" class="bg-red-500 text-white py-2 px-4 rounded-md mt-8 mx-auto block">Sair</button>
        </div>

        <!-- Modal de Verificação da Portaria -->
        <div id="modal-portaria" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white rounded-lg shadow-xl p-6 w-11/12 max-w-sm text-center">
                <img id="modal-foto" src="" alt="Foto do Sócio" class="w-32 h-40 object-cover rounded-lg mx-auto mb-4">
                <h3 id="modal-nome" class="text-xl font-bold"></h3>
                <p id="modal-nascimento" class="text-gray-600"></p>
                <p id="modal-parentesco" class="text-gray-500 mb-4"></p>
                <div id="modal-situacao" class="p-3 rounded-md font-semibold text-white mb-4"></div>
                <div class="flex justify-around mt-6">
                    <button id="btn-liberar-acesso" class="bg-green-500 text-white px-6 py-2 rounded-md">Liberar Acesso</button>
                    <button id="btn-encaminhar-secretaria" class="bg-yellow-500 text-white px-4 py-2 rounded-md">Encaminhar</button>
                </div>
                 <button onclick="closeModalPortaria()" class="mt-4 text-sm text-gray-500">Fechar</button>
            </div>
        </div>

        <!-- ======================================================================================= -->
        <!-- ============================= TELA DO SÓCIO FAMILIAR ================================== -->
        <!-- ======================================================================================= -->
        <div id="tela-socio-home" class="screen p-6">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Meu Passaporte</h2>
            <div id="socio-passaporte-info" class="bg-gray-50 p-4 rounded-lg mb-6 shadow"></div>
            <button id="btn-socio-situacao" class="w-full p-3 rounded-md mb-6 transition-all animate-pulse bg-gray-300">Verificar Situação Financeira</button>

            <hr class="my-6">
            <h3 class="text-xl font-semibold mb-4">Minhas Carteirinhas</h3>
            <div id="socio-lista-carteirinhas" class="space-y-4 mb-6"></div>

            <hr class="my-6">
            <h3 class="text-xl font-semibold mb-4">Detalhes Financeiros</h3>
            <div id="socio-financeiro-detalhes" class="hidden space-y-4">
                <div id="financeiro-vencidas"></div>
                <div id="financeiro-apagar"></div>
                <div id="financeiro-pagas"></div>
            </div>

            <button onclick="logout()" class="bg-red-500 text-white py-2 rounded-md mt-8 w-full">Sair</button>
        </div>


    </div> <!-- Fim do #app-container -->

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-functions-compat.js"></script>

    <!-- QR Code Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/davidshimjs-qrcodejs/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
        // =======================================================================================
        // ============================ INICIALIZAÇÃO E CONFIG DO FIREBASE =========================
        // =======================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCmdAtBmNaJAEJEiU6QfoqdwOUa7vhL8dk",
            authDomain: "sgbacquapark-julios.firebaseapp.com",
            projectId: "sgbacquapark-julios",
            storageBucket: "sgbacquapark-julios.appspot.com",
            messagingSenderId: "447883532999",
            appId: "1:447883532999:web:e40cb22f3465538038bce2",
            measurementId: "G-QDYMW2SDMM"
        };

        // Inicializa o Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const functions = firebase.functions();

        // Variáveis globais de estado
        let currentUserRole = null;
        let currentUserData = null;
        let currentPassportIdForEditing = null; // para saber qual passaporte está sendo editado
        let currentPassportDataForEditing = null;
        let html5QrCode = null;


        // =======================================================================================
        // =================================== ROTEAMENTO E AUTH =================================
        // =======================================================================================

        // Função de Roteamento Simples
        function navigateTo(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active-screen');
            });
            const targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.add('active-screen');
            } else {
                console.error(`Tela não encontrada: ${screenId}`);
                document.getElementById('tela-login').classList.add('active-screen');
            }
        }

        // Listener de estado de autenticação
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                try {
                    const idTokenResult = await user.getIdTokenResult(true); // Força a atualização do token
                    currentUserRole = idTokenResult.claims.role;
                    currentUserData = user;

                    if (currentUserRole === 'CEO') navigateTo('tela-ceo-home');
                    else if (currentUserRole === 'Secretaria') navigateTo('tela-gerenciar-passaportes');
                    else if (currentUserRole === 'Portaria') {
                        navigateTo('tela-portaria-home');
                        startQrCodeScanner();
                    }
                    else if (currentUserRole === 'SócioFamiliar') {
                        navigateTo('tela-socio-home');
                        loadSocioData();
                    }
                    else {
                        console.error('Papel (Role) do usuário não definido.');
                        navigateTo('tela-login');
                    }
                } catch (error) {
                    console.error("Erro ao obter o papel do usuário:", error);
                    logout();
                }
            } else {
                currentUserRole = null;
                currentUserData = null;
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Falha ao parar o scanner.", err));
                }
                navigateTo('tela-login');
            }
            // Esconde o loading screen inicial
            document.getElementById('tela-loading').classList.remove('active-screen');
        });

        // Logout
        function logout() {
            auth.signOut().catch(error => console.error("Erro no logout:", error));
        }

        // Botão de voltar genérico para telas de admin
        function goBackToHome() {
            if (currentUserRole === 'CEO') navigateTo('tela-ceo-home');
            else if (currentUserRole === 'Secretaria') navigateTo('tela-gerenciar-passaportes');
            else navigateTo('tela-login'); // fallback
        }

        // Login
        document.getElementById('form-login').addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorP = document.getElementById('login-error');
            errorP.textContent = '';

            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    console.error("Erro de login:", error);
                    errorP.textContent = 'Usuário ou senha inválidos.';
                });
        });

        // --- Lógica para configurar o primeiro CEO ---
        document.getElementById('setup-ceo-link').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = prompt("Por favor, insira o email do usuário que você JÁ CRIOU no painel do Firebase e que será o CEO:");
            if (!email) {
                return; // User cancelled the prompt
            }

            const setupInitialCEO = functions.httpsCallable('setupInitialCEO');
            try {
                const result = await setupInitialCEO({ email });
                alert(result.data.message);
                // O usuário precisará recarregar e fazer login novamente para que a nova role tenha efeito.
            } catch (error) {
                console.error("Erro ao configurar o CEO:", error);
                alert(`Erro: ${error.message}`);
            }
        });

        // Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => console.log('ServiceWorker registrado com sucesso: ', registration.scope))
                    .catch(err => console.log('Registro do ServiceWorker falhou: ', err));
            });
        }

        // =======================================================================================
        // ============================== LÓGICA DAS TELAS DO CEO ================================
        // =======================================================================================

        // --- Gerenciar Usuários ---
        const formCriarUsuario = document.getElementById('form-criar-usuario');
        formCriarUsuario.addEventListener('submit', async (e) => {
             e.preventDefault();
             const email = document.getElementById('novo-usuario-email').value;
             const role = document.getElementById('novo-usuario-role').value;

             const manageUser = functions.httpsCallable('manageUser');
             try {
                const result = await manageUser({ action: 'create', email, role });
                alert(result.data.message + `\nLink para reset de senha: ${result.data.passwordResetLink}`);
                formCriarUsuario.reset();
                loadUsers(); // Recarrega a lista
             } catch (error) {
                console.error("Erro ao criar usuário:", error);
                alert(`Erro: ${error.message}`);
             }
        });

        async function loadUsers() {
            const listaUsuariosDiv = document.getElementById('lista-usuarios');
            listaUsuariosDiv.innerHTML = '<p>Carregando usuários...</p>';
            try {
                const snapshot = await db.collection('users').orderBy('email').get();
                if (snapshot.empty) {
                    listaUsuariosDiv.innerHTML = '<p>Nenhum usuário encontrado.</p>';
                    return;
                }

                let html = '<div class="space-y-2">';
                snapshot.forEach(doc => {
                    const user = doc.data();
                    // Não listar o próprio CEO para evitar auto-exclusão acidental pela UI
                    if (user.uid === currentUserData.uid) {
                        return;
                    }

                    html += `
                        <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-bold">${user.email}</p>
                                <p class="text-sm text-gray-600">Papel: ${user.role}</p>
                            </div>
                            <button onclick="deleteUser('${user.uid}', '${user.email}')" class="text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-100" title="Excluir usuário">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    `;
                });
                html += '</div>';
                listaUsuariosDiv.innerHTML = html;
            } catch (error) {
                console.error("Erro ao carregar usuários:", error);
                listaUsuariosDiv.innerHTML = '<p class="text-red-500">Erro ao carregar usuários.</p>';
            }
        }

        async function deleteUser(uid, email) {
            if (!confirm(`Tem certeza que deseja excluir o usuário ${email}? Esta ação não pode ser desfeita.`)) {
                return;
            }

            const manageUser = functions.httpsCallable('manageUser');
            try {
                const result = await manageUser({ action: 'delete', uid: uid });
                alert(result.data.message);
                loadUsers(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao deletar usuário:", error);
                alert(`Erro: ${error.message}`);
            }
        }

        // --- Gerenciar Planos ---
        const formPlano = document.getElementById('form-plano');
        const listaPlanosDiv = document.getElementById('lista-planos');

        formPlano.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('plano-id').value;
            const nome = document.getElementById('plano-nome').value;
            const valor = parseFloat(document.getElementById('plano-valor').value);
            const descricao = document.getElementById('plano-descricao').value;

            const planoData = { nome, valor, descricao };

            try {
                if (id) { // Atualizar
                    await db.collection('plans').doc(id).update(planoData);
                    alert('Plano atualizado com sucesso!');
                } else { // Criar
                    await db.collection('plans').add(planoData);
                    alert('Plano criado com sucesso!');
                }
                resetFormPlano();
                loadPlanos();
            } catch (error) {
                console.error("Erro ao salvar plano:", error);
                alert('Erro ao salvar o plano.');
            }
        });

        function resetFormPlano() {
            formPlano.reset();
            document.getElementById('plano-id').value = '';
            document.getElementById('form-plano-titulo').textContent = 'Novo Plano';
        }

        async function loadPlanos() {
            try {
                const snapshot = await db.collection('plans').orderBy('nome').get();
                if (snapshot.empty) {
                    listaPlanosDiv.innerHTML = '<p>Nenhum plano encontrado.</p>';
                    return;
                }
                let html = '<div class="space-y-2">';
                snapshot.forEach(doc => {
                    const plano = doc.data();
                    html += `
                        <div class="bg-white p-3 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-bold">${plano.nome}</p>
                                <p class="text-sm text-gray-600">R$ ${plano.valor.toFixed(2)} - ${plano.descricao}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="editPlano('${doc.id}')" class="text-blue-500">Editar</button>
                                <button onclick="deletePlano('${doc.id}')" class="text-red-500">Excluir</button>
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
                listaPlanosDiv.innerHTML = html;
            } catch (error) {
                console.error("Erro ao carregar planos:", error);
                listaPlanosDiv.innerHTML = '<p class="text-red-500">Erro ao carregar planos.</p>';
            }
        }

        async function editPlano(id) {
            const doc = await db.collection('plans').doc(id).get();
            if (!doc.exists) return;
            const plano = doc.data();
            document.getElementById('plano-id').value = id;
            document.getElementById('plano-nome').value = plano.nome;
            document.getElementById('plano-valor').value = plano.valor;
            document.getElementById('plano-descricao').value = plano.descricao;
            document.getElementById('form-plano-titulo').textContent = 'Editando Plano';
            window.scrollTo(0, 0);
        }

        async function deletePlano(id) {
            if (confirm('Tem certeza que deseja excluir este plano?')) {
                await db.collection('plans').doc(id).delete();
                alert('Plano excluído.');
                loadPlanos();
            }
        }

        // =======================================================================================
        // ======================= LÓGICA DAS TELAS DE SECRETARIA / CEO ==========================
        // =======================================================================================

        // --- Gerenciar Passaportes ---
        const listaPassaportesDiv = document.getElementById('lista-passaportes');

        async function loadPassaportes(querySnapshot) {
            try {
                const snapshot = querySnapshot || await db.collection('passports').orderBy('createdAt', 'desc').limit(20).get();
                if (snapshot.empty) {
                    listaPassaportesDiv.innerHTML = '<p>Nenhum passaporte encontrado.</p>';
                    return;
                }
                let html = '<div class="space-y-3">';
                snapshot.forEach(doc => {
                    const p = doc.data();
                    html += `
                        <div class="bg-white p-4 rounded-lg shadow-sm flex justify-between items-center">
                            <div>
                                <p class="font-bold">${p.responsavel.nome}</p>
                                <p class="text-sm text-gray-600">Passaporte #${doc.id.substring(0, 6)}...</p>
                            </div>
                            <button onclick="editPassaporte('${doc.id}')" class="bg-blue-500 text-white px-4 py-2 rounded">Editar</button>
                        </div>
                    `;
                });
                html += '</div>';
                listaPassaportesDiv.innerHTML = html;
            } catch (error) {
                 console.error("Erro ao carregar passaportes:", error);
                listaPassaportesDiv.innerHTML = '<p class="text-red-500">Erro ao carregar passaportes.</p>';
            }
        }

        // --- Criar Passaporte ---
        const formCriarPassaporte = document.getElementById('form-criar-passaporte');

        // Lógica para mostrar/esconder campos de passaporte antigo
        document.querySelectorAll('input[name="passaporte-novo"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                const camposAntigos = document.getElementById('campos-passaporte-antigo');
                if (e.target.value === 'nao') {
                    camposAntigos.classList.remove('hidden');
                } else {
                    camposAntigos.classList.add('hidden');
                }
            });
        });

        formCriarPassaporte.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nome = document.getElementById('resp-nome').value;
            const cpf = document.getElementById('resp-cpf').value;
            const email = document.getElementById('resp-email').value;
            const planoId = document.getElementById('resp-plano').value;

            // 1. Gerar número do passaporte ANTES de qualquer outra coisa
            const generatePassportNumber = functions.httpsCallable('generatePassportNumber');
            let newPassportNumber;
            try {
                const result = await generatePassportNumber();
                newPassportNumber = result.data.passportNumber;
            } catch (error) {
                console.error("Erro ao gerar número do passaporte:", error);
                alert(`Erro crítico: Não foi possível gerar um número de passaporte. A criação foi cancelada. Detalhes: ${error.message}`);
                return;
            }

            // 2. Chamar function para criar/buscar cliente Asaas
            const handleAsaasCustomer = functions.httpsCallable('handleAsaasCustomer');
            let asaasCustomerId;
            try {
                const result = await handleAsaasCustomer({
                    cpf,
                    name: nome,
                    email,
                    phone: document.getElementById('resp-telefone').value
                });
                asaasCustomerId = result.data.asaasCustomerId;
                alert(`Cliente Asaas ${result.data.isNew ? 'criado' : 'encontrado'}. ID: ${asaasCustomerId}`);
            } catch (error) {
                console.error("Erro ao lidar com cliente Asaas:", error);
                alert(`Erro Asaas: ${error.message}`);
                return;
            }

            // 3. Chamar function para criar usuário no Firebase Auth
            const manageUser = functions.httpsCallable('manageUser');
            try {
                const result = await manageUser({ action: 'create', email, role: 'SócioFamiliar' });
                alert(result.data.message);
                // O UID será associado ao passaporte no primeiro login do sócio.
            } catch (error) {
                console.error("Erro ao criar usuário SócioFamiliar:", error);
                alert(`Erro ao criar usuário: ${error.message}`);
                 if (!error.message.includes("already exists")) {
                    return; // Não continuar se o usuário não for criado e não for um erro de "já existe"
                }
            }

            // 4. Salvar passaporte no Firestore
            try {
                 const passaporteData = {
                    numeroPassaporte: newPassportNumber,
                    responsavel: {
                        nome: nome,
                        cpf: cpf,
                        nascimento: document.getElementById('resp-nascimento').value,
                        email: email,
                        telefone: document.getElementById('resp-telefone').value,
                        endereco: document.getElementById('resp-endereco').value,
                    },
                    planoId: planoId,
                    asaasCustomerId: asaasCustomerId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    status: 'Ativo', // Adicionando um status inicial
                    isNewPassport: document.getElementById('passaporte-novo-sim').checked,
                    oldPassportInfo: {
                        type: document.getElementById('passaporte-novo-nao').checked ? document.getElementById('tipo-passaporte-antigo').value : null,
                        number: document.getElementById('passaporte-novo-nao').checked ? document.getElementById('numero-passaporte-antigo').value : null,
                    }
                };
                const docRef = await db.collection('passports').add(passaporteData);
                alert(`Passaporte #${newPassportNumber} criado com sucesso!`);
                formCriarPassaporte.reset();
                document.getElementById('campos-passaporte-antigo').classList.add('hidden'); // Esconde os campos de volta
                navigateTo('tela-gerenciar-passaportes');
                loadPassaportes();
            } catch (error) {
                console.error("Erro ao salvar passaporte:", error);
                alert(`Erro ao salvar passaporte: ${error.message}`);
            }
        });

        async function populatePlanosSelect(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecione um Plano...</option>';
            const snapshot = await db.collection('plans').get();
            snapshot.forEach(doc => {
                const plano = doc.data();
                select.innerHTML += `<option value="${doc.id}">${plano.nome} - R$ ${plano.valor}</option>`;
            });
        }

        // --- Editar Passaporte ---
        async function editPassaporte(passportId) {
            currentPassportIdForEditing = passportId;
            try {
                const doc = await db.collection('passports').doc(passportId).get();
                if (!doc.exists) {
                    alert('Passaporte não encontrado.');
                    return;
                }
                currentPassportDataForEditing = {id: doc.id, ...doc.data()};
                const p = currentPassportDataForEditing;

                // Preencher campos não editáveis
                document.getElementById('passaporte-info-nao-editavel').innerHTML = `
                    <p><strong>Nº Passaporte:</strong> ${p.id.substring(0,6)}...</p>
                    <p><strong>Nome:</strong> ${p.responsavel.nome}</p>
                    <p><strong>CPF:</strong> ${p.responsavel.cpf}</p>
                `;

                // Preencher formulário de campos editáveis
                const form = document.getElementById('form-editar-passaporte');
                form.innerHTML = `
                     <input type="email" id="edit-resp-email" value="${p.responsavel.email}" class="w-full p-2 border rounded">
                     <input type="tel" id="edit-resp-telefone" value="${p.responsavel.telefone}" class="w-full p-2 border rounded">
                     <input type="text" id="edit-resp-endereco" value="${p.responsavel.endereco}" class="w-full p-2 border rounded">
                     <select id="edit-resp-plano" class="w-full p-2 border rounded bg-white"></select>
                     <button type="submit" class="w-full bg-blue-500 text-white p-2 rounded">Salvar Alterações</button>
                `;
                await populatePlanosSelect('edit-resp-plano');
                document.getElementById('edit-resp-plano').value = p.planoId;

                // Carregar carteirinhas
                loadCarteirinhasDoPassaporte(passportId);

                navigateTo('tela-editar-passaporte');
            } catch (error) {
                console.error("Erro ao carregar passaporte para edição:", error);
                alert('Erro ao carregar dados.');
            }
        }

        document.getElementById('form-editar-passaporte').addEventListener('submit', async (e) => {
            e.preventDefault();
            const updatedData = {
                'responsavel.email': document.getElementById('edit-resp-email').value,
                'responsavel.telefone': document.getElementById('edit-resp-telefone').value,
                'responsavel.endereco': document.getElementById('edit-resp-endereco').value,
                'planoId': document.getElementById('edit-resp-plano').value,
            };
            try {
                await db.collection('passports').doc(currentPassportIdForEditing).update(updatedData);
                alert('Passaporte atualizado com sucesso!');
                navigateTo('tela-gerenciar-passaportes');
            } catch(error) {
                alert('Erro ao atualizar: ' + error.message);
            }
        });

        async function loadCarteirinhasDoPassaporte(passportId) {
            const div = document.getElementById('lista-carteirinhas-passaporte');
            div.innerHTML = '<p>Carregando carteirinhas...</p>';
            const snapshot = await db.collection('passports').doc(passportId).collection('cards').get();
            if (snapshot.empty) {
                div.innerHTML = '<p>Nenhuma carteirinha vinculada.</p>';
                return;
            }
            let html = '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
            snapshot.forEach(doc => {
                const c = doc.data();
                html += `
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <img src="${c.fotoRostoUrl || 'https://via.placeholder.com/96x128'}" class="w-24 h-32 object-cover rounded mx-auto mb-2">
                        <p class="font-bold text-center">${c.nome}</p>
                        <p class="text-sm text-center text-gray-500">${c.parentesco}</p>
                        <div class="w-16 h-16 mx-auto my-2" id="qr-${doc.id}"></div>
                        <button onclick="editCarteirinha('${passportId}', '${doc.id}')" class="w-full text-center text-blue-600 mt-2">Editar</button>
                    </div>
                `;
                // Gerar QR Code depois que o elemento estiver no DOM
                setTimeout(() => new QRCode(document.getElementById(`qr-${doc.id}`), {
                    text: `${passportId}/${doc.id}`,
                    width: 64,
                    height: 64,
                }), 100);
            });
            html += '</div>';
            div.innerHTML = html;
        }

        // --- Adicionar/Editar Carteirinha ---
        function navigateToAddCard() {
            resetCarteirinhaForm();
            document.getElementById('carteirinha-passaporte-id').value = currentPassportIdForEditing;
            navigateTo('tela-adicionar-carteirinha');
        }

        function goBackToEditPassport() {
            navigateTo('tela-editar-passaporte');
            // Recarregar dados pode ser necessário
            editPassaporte(currentPassportIdForEditing);
        }

        async function editCarteirinha(passportId, cardId) {
            resetCarteirinhaForm();
            const doc = await db.collection('passports').doc(passportId).collection('cards').doc(cardId).get();
            if (!doc.exists) return;
            const c = doc.data();
            document.getElementById('carteirinha-form-title').textContent = 'Editar Carteirinha';
            document.getElementById('carteirinha-passaporte-id').value = passportId;
            document.getElementById('carteirinha-id').value = cardId;
            document.getElementById('carteirinha-parentesco').value = c.parentesco;
            document.getElementById('carteirinha-nome').value = c.nome;
            document.getElementById('carteirinha-doc').value = c.cpfDoc;
            document.getElementById('carteirinha-nascimento').value = c.nascimento;

            if (c.fotoRostoUrl) {
                document.getElementById('rosto-preview').src = c.fotoRostoUrl;
                document.getElementById('rosto-preview').classList.remove('hidden');
            }
            if (c.fotoDocUrl) {
                document.getElementById('doc-preview').src = c.fotoDocUrl;
                document.getElementById('doc-preview').classList.remove('hidden');
            }

            navigateTo('tela-adicionar-carteirinha');
        }

        function resetCarteirinhaForm() {
            document.getElementById('form-carteirinha').reset();
            document.getElementById('carteirinha-form-title').textContent = 'Adicionar Carteirinha';
            document.getElementById('carteirinha-id').value = '';
            document.getElementById('rosto-preview').classList.add('hidden');
            document.getElementById('doc-preview').classList.add('hidden');
        }

        const formCarteirinha = document.getElementById('form-carteirinha');
        formCarteirinha.addEventListener('submit', async (e) => {
            e.preventDefault();
            const passportId = document.getElementById('carteirinha-passaporte-id').value;
            const cardId = document.getElementById('carteirinha-id').value || db.collection('passports').doc().id; // Gera novo ID se não houver

            const fileRosto = document.getElementById('carteirinha-foto-rosto').files[0];
            const fileDoc = document.getElementById('carteirinha-foto-doc').files[0];

            try {
                let fotoRostoUrl = document.getElementById('rosto-preview').src;
                let fotoDocUrl = document.getElementById('doc-preview').src;

                if (fileRosto) {
                    const compressedRosto = await compressImage(fileRosto, 0.8, 150 * 1024);
                    const storageRef = storage.ref(`passports/${passportId}/${cardId}_face.jpg`);
                    const snapshot = await storageRef.put(compressedRosto);
                    fotoRostoUrl = await snapshot.ref.getDownloadURL();
                }
                if (fileDoc) {
                    const compressedDoc = await compressImage(fileDoc, 0.8, 400 * 1024);
                    const storageRef = storage.ref(`passports/${passportId}/${cardId}_doc.jpg`);
                    const snapshot = await storageRef.put(compressedDoc);
                    fotoDocUrl = await snapshot.ref.getDownloadURL();
                }

                const cardData = {
                    nome: document.getElementById('carteirinha-nome').value,
                    nascimento: document.getElementById('carteirinha-nascimento').value,
                    parentesco: document.getElementById('carteirinha-parentesco').value,
                    cpfDoc: document.getElementById('carteirinha-doc').value,
                    qrCodeData: `${passportId}/${cardId}`,
                    fotoRostoUrl: fotoRostoUrl || null,
                    fotoDocUrl: fotoDocUrl || null,
                };

                await db.collection('passports').doc(passportId).collection('cards').doc(cardId).set(cardData, { merge: true });

                alert('Carteirinha salva com sucesso!');
                goBackToEditPassport();

            } catch (error) {
                console.error("Erro ao salvar carteirinha:", error);
                alert("Erro ao salvar: " + error.message);
            }
        });

        // Função para comprimir imagem
        function compressImage(file, quality, maxSizeInBytes) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Redimensionar para proporção 3x4 (rosto)
                        let width = img.width;
                        let height = img.height;
                        if (file.name.includes('face')) { // Apenas para foto de rosto
                            const targetAspectRatio = 3/4;
                            const currentAspectRatio = width / height;
                            if (currentAspectRatio > targetAspectRatio) {
                                width = height * targetAspectRatio;
                            } else {
                                height = width / targetAspectRatio;
                            }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob((blob) => {
                            if (blob.size > maxSizeInBytes) {
                                // Se ainda for muito grande, poderia tentar comprimir mais,
                                // mas por simplicidade, vamos apenas notificar.
                                console.warn("A imagem comprimida ainda excede o tamanho máximo.");
                            }
                            resolve(blob);
                        }, 'image/jpeg', quality);
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        }

        document.getElementById('carteirinha-foto-rosto').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const preview = document.getElementById('rosto-preview');
                preview.src = URL.createObjectURL(e.target.files[0]);
                preview.classList.remove('hidden');
            }
        });
         document.getElementById('carteirinha-foto-doc').addEventListener('change', (e) => {
            if (e.target.files[0]) {
                const preview = document.getElementById('doc-preview');
                preview.src = URL.createObjectURL(e.target.files[0]);
                preview.classList.remove('hidden');
            }
        });


        // =======================================================================================
        // ============================ LÓGICA DA TELA DE PORTARIA ===============================
        // =======================================================================================

        function startQrCodeScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };

            const qrCodeSuccessCallback = async (decodedText, decodedResult) => {
                if (html5QrCode.isScanning) {
                    await html5QrCode.stop();
                }
                document.getElementById('qr-reader-results').textContent = `QR Code detectado: ${decodedText}`;

                const [passportId, cardId] = decodedText.split('/');
                if (!passportId || !cardId) {
                    alert('QR Code inválido.');
                    restartQrScanner();
                    return;
                }

                try {
                    // Buscar dados da carteirinha e do passaporte
                    const cardDoc = await db.collection('passports').doc(passportId).collection('cards').doc(cardId).get();
                    const passportDoc = await db.collection('passports').doc(passportId).get();

                    if (!cardDoc.exists || !passportDoc.exists) {
                        alert('Carteirinha ou passaporte não encontrado.');
                        restartQrScanner();
                        return;
                    }

                    const cardData = cardDoc.data();
                    const passportData = passportDoc.data();

                    // Chamar function para verificar situação financeira
                    const getFinancialStatus = functions.httpsCallable('getFinancialStatus');
                    const financialResult = await getFinancialStatus({ asaasCustomerId: passportData.asaasCustomerId });

                    // Exibir modal
                    showModalPortaria(cardData, financialResult.data.status);

                } catch (error) {
                    console.error("Erro ao processar QR Code:", error);
                    alert('Erro ao verificar dados: ' + error.message);
                    restartQrScanner();
                }
            };

            html5QrCode.start({ facingMode: "environment" }, config, qrCodeSuccessCallback)
                .catch(err => console.log(`Não foi possível iniciar o scanner: ${err}`));
        }

        function restartQrScanner() {
            document.getElementById('qr-reader-results').textContent = '';
            if (!html5QrCode.isScanning) {
                 startQrCodeScanner();
            }
        }

        function showModalPortaria(cardData, financialStatus) {
            document.getElementById('modal-foto').src = cardData.fotoRostoUrl || 'https://via.placeholder.com/128x170';
            document.getElementById('modal-nome').textContent = cardData.nome;
            document.getElementById('modal-nascimento').textContent = `Nasc: ${cardData.nascimento}`;
            document.getElementById('modal-parentesco').textContent = cardData.parentesco;

            const situacaoDiv = document.getElementById('modal-situacao');
            if (financialStatus.vencidas.length > 0) {
                situacaoDiv.textContent = 'PENDÊNCIA FINANCEIRA';
                situacaoDiv.className = 'p-3 rounded-md font-semibold text-white bg-red-500';
            } else {
                situacaoDiv.textContent = 'SITUAÇÃO REGULAR';
                situacaoDiv.className = 'p-3 rounded-md font-semibold text-white bg-green-500';
            }

            document.getElementById('modal-portaria').classList.remove('hidden');

            // Lógica dos botões do modal
            document.getElementById('btn-liberar-acesso').onclick = () => logAccess(cardData, 'liberado');
            document.getElementById('btn-encaminhar-secretaria').onclick = () => logAccess(cardData, 'encaminhado');
        }

        function closeModalPortaria() {
            document.getElementById('modal-portaria').classList.add('hidden');
            restartQrScanner();
        }

        async function logAccess(cardData, action) {
             try {
                await db.collection('access_logs').add({
                    cardId: cardData.qrCodeData.split('/')[1],
                    passportId: cardData.qrCodeData.split('/')[0],
                    cardName: cardData.nome,
                    action: action,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    portariaUser: currentUserData.email,
                });
                alert(`Acesso registrado como: ${action}`);
                closeModalPortaria();
            } catch (error) {
                console.error("Erro ao registrar log:", error);
                alert("Erro ao registrar log.");
            }
        }

        // =======================================================================================
        // ========================= LÓGICA DA TELA DO SÓCIO FAMILIAR ============================
        // =======================================================================================
        async function loadSocioData() {
            try {
                // Encontra o passaporte associado ao UID do usuário logado
                const snapshot = await db.collection('passports').where('uid', '==', currentUserData.uid).limit(1).get();

                if (snapshot.empty) {
                    // Se não encontrar por UID, tenta associar pelo email (primeiro login)
                    const emailSnapshot = await db.collection('passports').where('responsavel.email', '==', currentUserData.email).limit(1).get();
                    if(emailSnapshot.empty) {
                        document.getElementById('socio-passaporte-info').innerHTML = '<p>Nenhum passaporte encontrado para este usuário.</p>';
                        return;
                    }
                    // Associa o UID
                    const passportDoc = emailSnapshot.docs[0];
                    await passportDoc.ref.update({ uid: currentUserData.uid });
                    loadSocioData(); // Recarrega com a associação feita
                    return;
                }

                const passportDoc = snapshot.docs[0];
                const passportData = {id: passportDoc.id, ...passportDoc.data()};

                // Exibir info do passaporte
                const planoDoc = await db.collection('plans').doc(passportData.planoId).get();
                const planoNome = planoDoc.exists ? planoDoc.data().nome : "Não informado";
                document.getElementById('socio-passaporte-info').innerHTML = `
                    <p><strong>Nº Passaporte:</strong> ${passportData.id.substring(0,6)}...</p>
                    <p><strong>Responsável:</strong> ${passportData.responsavel.nome}</p>
                    <p><strong>Plano:</strong> ${planoNome}</p>
                `;

                // Carregar carteirinhas
                loadSocioCarteirinhas(passportData.id);

                // Lógica do botão de situação financeira
                const btnSituacao = document.getElementById('btn-socio-situacao');
                btnSituacao.onclick = async () => {
                     btnSituacao.textContent = 'Verificando...';
                     btnSituacao.disabled = true;
                     const getFinancialStatus = functions.httpsCallable('getFinancialStatus');
                     try {
                        const result = await getFinancialStatus({ asaasCustomerId: passportData.asaasCustomerId });
                        const status = result.data.status;

                        // Atualiza o botão
                        if (status.vencidas.length > 1) {
                            btnSituacao.className = 'w-full p-3 rounded-md mb-6 transition-all bg-red-500 text-white';
                            btnSituacao.textContent = 'Situação: Irregular (>1 vencida)';
                        } else if (status.vencidas.length === 1) {
                            btnSituacao.className = 'w-full p-3 rounded-md mb-6 transition-all bg-yellow-400 text-black';
                            btnSituacao.textContent = 'Situação: Atenção (1 vencida)';
                        } else {
                            btnSituacao.className = 'w-full p-3 rounded-md mb-6 transition-all bg-green-500 text-white';
                            btnSituacao.textContent = 'Situação: Regular';
                        }

                        // Exibe os detalhes
                        displayFinancialDetails(status);

                     } catch(error) {
                         console.error(error);
                         btnSituacao.className = 'w-full p-3 rounded-md mb-6 transition-all bg-gray-500 text-white';
                         btnSituacao.textContent = 'Erro ao verificar';
                     } finally {
                         btnSituacao.disabled = false;
                     }
                };

                // Dispara a verificação ao carregar a tela
                btnSituacao.click();

            } catch (error) {
                console.error("Erro ao carregar dados do sócio:", error);
                document.getElementById('socio-passaporte-info').innerHTML = '<p class="text-red-500">Erro ao carregar seus dados.</p>';
            }
        }

        async function loadSocioCarteirinhas(passportId) {
            const div = document.getElementById('socio-lista-carteirinhas');
            div.innerHTML = '';
            const snapshot = await db.collection('passports').doc(passportId).collection('cards').get();
            snapshot.forEach(doc => {
                const c = doc.data();
                const cardElement = document.createElement('div');
                cardElement.className = 'bg-white p-4 rounded-lg shadow-md flex items-center gap-4';
                cardElement.innerHTML = `
                    <img src="${c.fotoRostoUrl || 'https://via.placeholder.com/96x128'}" class="w-24 h-32 object-cover rounded">
                    <div>
                        <p class="font-bold text-lg">${c.nome}</p>
                        <p class="text-gray-600">${c.parentesco}</p>
                        <div class="w-24 h-24 mt-2" id="socio-qr-${doc.id}"></div>
                    </div>
                `;
                div.appendChild(cardElement);
                new QRCode(document.getElementById(`socio-qr-${doc.id}`), {
                    text: `${passportId}/${doc.id}`,
                    width: 96,
                    height: 96,
                });
            });
        }

        function displayFinancialDetails(status) {
            const detalhesDiv = document.getElementById('socio-financeiro-detalhes');
            const vencidasDiv = document.getElementById('financeiro-vencidas');
            const apagarDiv = document.getElementById('financeiro-apagar');
            const pagasDiv = document.getElementById('financeiro-pagas');

            vencidasDiv.innerHTML = '<h4>Vencidas</h4>' + (status.vencidas.length > 0 ? status.vencidas.map(p => financialItem(p, 'red')).join('') : '<p>Nenhuma.</p>');
            apagarDiv.innerHTML = '<h4>A Pagar</h4>' + (status.aPagar.length > 0 ? status.aPagar.map(p => financialItem(p, 'yellow')).join('') : '<p>Nenhuma.</p>');
            pagasDiv.innerHTML = '<h4>Pagas (últimas 5)</h4>' + (status.pagas.length > 0 ? status.pagas.slice(0,5).map(p => financialItem(p, 'green')).join('') : '<p>Nenhuma.</p>');

            detalhesDiv.classList.remove('hidden');
            detalhesDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function financialItem(payment, color) {
            return `
                <div class="border-l-4 border-${color}-500 p-3 bg-gray-50 rounded-r-lg">
                    <div class="flex justify-between">
                        <span class="font-semibold">R$ ${payment.value.toFixed(2)}</span>
                        <span class="text-sm">Venc: ${new Date(payment.dueDate).toLocaleDateString()}</span>
                    </div>
                    ${payment.bankSlipUrl ? `<a href="${payment.bankSlipUrl}" target="_blank" class="text-blue-600 hover:underline">Ver Boleto</a>` : ''}
                </div>
            `;
        }

        // =======================================================================================
        // =================================== Gatilhos de UI ====================================
        // =======================================================================================

        // Gatilhos que são executados quando uma tela se torna visível
        const observer = new MutationObserver((mutations) => {
            for (const mutation of mutations) {
                if (mutation.attributeName === 'class') {
                    const target = mutation.target;
                    if (target.classList.contains('active-screen')) {
                        // A tela se tornou ativa, rodar a lógica correspondente
                        switch (target.id) {
                            case 'tela-ceo-usuarios': loadUsers(); break;
                            case 'tela-ceo-planos': loadPlanos(); break;
                            case 'tela-gerenciar-passaportes': loadPassaportes(); break;
                            case 'tela-criar-passaporte': populatePlanosSelect('resp-plano'); break;
                        }
                    }
                }
            }
        });

        document.querySelectorAll('.screen').forEach(screen => {
            observer.observe(screen, { attributes: true });
        });

    </script>
</body>
</html>
